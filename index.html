<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Buscador Talleres de Diseño</title>
  <style>
    :root { --gap: 12px; }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:24px; background:#fff}
    .wrap{max-width:1200px;margin:0 auto}
    .header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
    .logo{height:48px;width:auto;display:block}
    .title{font-size:24px;margin:0;line-height:1.15}

    /* Layout principal: contenido + aside */
    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 16px;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .card{padding:20px;border:1px solid #e7e7e7;border-radius:12px;background:#fff}
    .row{display:flex;gap:var(--gap);flex-wrap:wrap;margin-bottom:var(--gap)}
    label{font-size:14px;color:#333}
    select,button{padding:10px 12px;font-size:16px}
    button{cursor:pointer}
    .muted{color:#666;font-size:14px}
    .hr{height:1px;background:#eee;margin:16px 0}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .counter{font-weight:600;border:1px solid #ddd;border-radius:8px;padding:6px 10px}

    /* Resultados */
    .comision-card{border:1px solid #e9e9e9;border-radius:10px;padding:12px;margin-top:12px}
    .comision-title{font-weight:600;margin:0 0 8px 0}
    .mini-table{width:100%;border-collapse:collapse}
    .mini-table th,.mini-table td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
    .mini-table th{background:#f7f7f7}

    /* Aside (Dirección + Mapa) */
    .aside{padding:16px;border:1px solid #e7e7e7;border-radius:12px;background:#fff}
    .aside-title{margin:0 0 8px 0;font-size:16px;font-weight:700}
    .aside-box{font-size:14px;color:#333;white-space:pre-wrap}
    .aside-muted{font-size:13px;color:#666;margin-top:6px}
    .map-wrap{margin-top:10px}
    .map-select{margin-top:8px}
    .map-frame{width:100%;height:260px;border:0;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header con logo a la izquierda -->
    <div class="header">
      <img src="logo.png" alt="Logo" class="logo"/>
      <h1 class="title">Buscador Talleres de Diseño</h1>
    </div>

    <div class="layout">
      <!-- Columna principal -->
      <div class="card">
        <p class="muted">Elegí primero la <b>Escuela</b>, después el <b>Día</b>, luego el <b>Horario</b>. Te mostramos las <b>Comisiones</b> disponibles con sus datos.</p>

        <div class="row">
          <div>
            <label for="escuela">Escuela</label><br/>
            <select id="escuela" disabled>
              <option value="">(Elegí escuela)</option>
            </select>
          </div>
          <div>
            <label for="dia">Día</label><br/>
            <select id="dia" disabled>
              <option value="">(Elegí día)</option>
            </select>
          </div>
          <div>
            <label for="horario">Horario</label><br/>
            <select id="horario" disabled>
              <option value="">(Elegí horario)</option>
            </select>
          </div>
          <div style="align-self:end;">
            <button id="limpiar" disabled>Limpiar</button>
          </div>
        </div>

        <div class="meta">
          <div id="status" class="muted">Cargando datos…</div>
          <div id="contador" class="counter" aria-live="polite">Comisiones: 0</div>
        </div>

        <div class="hr"></div>

        <div>
          <div class="muted">Resultados:</div>
          <div id="resultados"></div>
        </div>
      </div>

      <!-- Aside con Dirección + Mapa -->
      <aside class="aside" id="aside-direccion" style="display:none;">
        <h3 class="aside-title">Dirección de la escuela</h3>

        <div class="aside-box" id="direccion-value"></div>

        <!-- Selector de dirección (si hay varias) -->
        <div class="map-select" id="direccion-select-wrap" style="display:none;">
          <label for="direccion-select" class="muted">Ver en mapa:</label><br/>
          <select id="direccion-select"></select>
        </div>

        <div class="map-wrap">
          <!-- Mapa embebido (Google Maps) -->
          <iframe id="map-frame" class="map-frame" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>

        <div class="aside-muted">Se completa al elegir una escuela.</div>
      </aside>
    </div>
  </div>

  <script>
    // === CSV público ===
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgHmSCDyof2tEKeRp77d9vnBhpQvAbVfy1NDqDE_Q9CvvGVaObzWLEjnjRYlJCJhVPTDR8fwckvu4D/pub?output=csv";

    // Helpers
    const normalize = s => String(s||"").toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const uniq = arr => Array.from(new Set(arr.filter(v => v!==undefined && v!==null && String(v).trim()!=="")));

    // CSV parser básico con comillas dobles
    function parseCSV(text) {
      const rows = [];
      let row = [], val = "", inQuotes = false;
      for (let i=0; i<text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"') {
          if (inQuotes && n === '"') { val += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (c === ',' && !inQuotes) {
          row.push(val); val = "";
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (val !== "" || row.length) { row.push(val); rows.push(row); row = []; val = ""; }
        } else {
          val += c;
        }
      }
      if (val !== "" || row.length) row.push(val), rows.push(row);
      return rows;
    }

    // Estado
    let HEADERS=[], ROWS=[];
    let H_ESC=null, H_DIA=null, H_HOR=null, H_COM=null;
    let H_DIR_SCHOOL=null; // "direccion de la escuela"
    let EXTRA_HEADERS=[];

    // UI refs
    const $escuela = document.getElementById('escuela');
    const $dia     = document.getElementById('dia');
    const $horario = document.getElementById('horario');
    const $status  = document.getElementById('status');
    const $limpiar = document.getElementById('limpiar');
    const $contador = document.getElementById('contador');
    const $resultados = document.getElementById('resultados');

    const $asideDir = document.getElementById('aside-direccion');
    const $dirVal   = document.getElementById('direccion-value');
    const $mapFrame = document.getElementById('map-frame');
    const $dirSelectWrap = document.getElementById('direccion-select-wrap');
    const $dirSelect = document.getElementById('direccion-select');

    // Mapa: armar URL de embed (sin API key)
    function mapEmbedURL(address){
      const q = encodeURIComponent(address);
      // Búsqueda simple en Google Maps (no requiere API key)
      return `https://www.google.com/maps?q=${q}&output=embed`;
    }

    function setDireccionAside(direcciones) {
      // direcciones: array de strings (puede venir vacío)
      const list = (direcciones || []).map(d => String(d).trim()).filter(Boolean);
      if (!list.length) {
        $dirVal.textContent = "";
        $asideDir.style.display = "none";
        $mapFrame.removeAttribute('src');
        $dirSelectWrap.style.display = "none";
        $dirSelect.innerHTML = "";
        return;
      }

      $asideDir.style.display = "block";
      // Texto: todas las direcciones unidas (informativo)
      $dirVal.textContent = list.join(" • ");

      // Selector si hay varias
      if (list.length > 1) {
        $dirSelectWrap.style.display = "block";
        $dirSelect.innerHTML = "";
        list.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d; opt.textContent = d.length > 60 ? (d.slice(0,60) + '…') : d;
          if (i === 0) opt.selected = true;
          $dirSelect.appendChild(opt);
        });
      } else {
        $dirSelectWrap.style.display = "none";
        $dirSelect.innerHTML = "";
      }

      // Mostrar en mapa la primera (o la seleccionada si ya hay select)
      const addr = $dirSelect.value || list[0];
      $mapFrame.src = mapEmbedURL(addr);
    }

    // Cambiar mapa al elegir otra dirección del selector
    $dirSelect.addEventListener('change', () => {
      const addr = $dirSelect.value;
      if (addr) $mapFrame.src = mapEmbedURL(addr);
    });

    // Carga inicial
    (async function init(){
      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        const text = await res.text();
        const raw = parseCSV(text);
        if (!raw.length) throw new Error("CSV vacío");

        HEADERS = raw[0].map(h => String(h).trim());
        const byNorm = new Map(HEADERS.map(h => [normalize(h), h]));

        // Detectar encabezados (acepta variantes con y sin tilde)
        H_ESC = byNorm.get('escuela') || byNorm.get('escuelas') || null;
        H_DIA = byNorm.get('dia') || byNorm.get('día') || null;
        H_HOR = byNorm.get('horario') || byNorm.get('turno') || null;
        H_COM = byNorm.get('comision') || byNorm.get('comisión') || null;

        // NUEVO: "direccion de la escuela" (con o sin tildes)
        H_DIR_SCHOOL =
          byNorm.get('direccion de la escuela') ||
          byNorm.get('dirección de la escuela') ||
          byNorm.get('direccion escuela') ||
          byNorm.get('dirección escuela') || null;

        if (!H_ESC || !H_DIA || !H_HOR || !H_COM) {
          throw new Error("Encabezados requeridos no encontrados. Se esperan: Escuela, DIA, HORARIO, COMISION.");
        }

        // Columnas extra = todas menos las 4 clave y la de dirección general (para no repetirla en la tabla)
        const coreSet = new Set([H_ESC, H_DIA, H_HOR, H_COM, H_DIR_SCHOOL].filter(Boolean));
        EXTRA_HEADERS = HEADERS.filter(h => !coreSet.has(h));

        ROWS = raw.slice(1).map(r => {
          const o={};
          HEADERS.forEach((h,i)=>o[h]=r[i]);
          return o;
        });

        // Poblar ESCUELA
        const escuelas = uniq(ROWS.map(r => String(r[H_ESC]).trim())).sort();
        for (const e of escuelas) {
          const opt = document.createElement('option'); opt.value=e; opt.textContent=e; $escuela.appendChild(opt);
        }
        $escuela.disabled = false;
        $limpiar.disabled = false;
        $status.textContent = "Listo. Elegí escuela.";
      }catch(err){
        console.error(err);
        $status.textContent = "No pude leer el CSV o faltan encabezados. Revisá permisos/columnas.";
      }
    })();

    // Utilidades UI
    function resetDiaHorarioYResultados() {
      $dia.innerHTML = '<option value="">(Elegí día)</option>';
      $horario.innerHTML = '<option value="">(Elegí horario)</option>';
      $dia.disabled = true; $horario.disabled = true;
      $resultados.innerHTML = "";
      updateCounter(0);
    }

    function updateCounter(n) {
      $contador.textContent = `Comisiones: ${n}`;
    }

    function renderResultados(gruposPorComision) {
      $resultados.innerHTML = "";
      const comisiones = Object.keys(gruposPorComision).sort((a,b)=>a.localeCompare(b, 'es'));
      updateCounter(comisiones.length);

      comisiones.forEach(com => {
        const card = document.createElement('div');
        card.className = 'comision-card';

        const h = document.createElement('p');
        h.className = 'comision-title';
        h.textContent = com || '(Sin nombre de comisión)';
        card.appendChild(h);

        // Tabla con columnas extra (si hay)
        if (EXTRA_HEADERS.length) {
          const table = document.createElement('table');
          table.className = 'mini-table';

          const thead = document.createElement('thead');
          const trh = document.createElement('tr');
          EXTRA_HEADERS.forEach(hh => {
            const th = document.createElement('th'); th.textContent = hh; trh.appendChild(th);
          });
          thead.appendChild(trh);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          gruposPorComision[com].forEach(row => {
            const tr = document.createElement('tr');
            EXTRA_HEADERS.forEach(hh => {
              const td = document.createElement('td');
              td.textContent = row[hh] != null ? row[hh] : "";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          card.appendChild(table);
        }

        $resultados.appendChild(card);
      });

      if (!comisiones.length) {
        $status.textContent = "Sin comisiones para esa combinación.";
      } else {
        $status.textContent = `Listo: ${comisiones.length} comisión(es) encontrada(s).`;
      }
    }

    // Cascada: Escuela -> Día (y setear dirección + mapa)
    $escuela.addEventListener('change', () => {
      resetDiaHorarioYResultados();

      const esc = $escuela.value.trim();

      // Actualizar DIRECCIÓN + MAPA
      if (H_DIR_SCHOOL && esc) {
        const dirs = uniq(
          ROWS.filter(r => String(r[H_ESC]).trim() === esc)
              .map(r => String(r[H_DIR_SCHOOL] || "").trim())
              .filter(Boolean)
        );
        setDireccionAside(dirs);
      } else {
        setDireccionAside([]);
      }

      if (!esc) { $status.textContent = "Elegí escuela."; return; }

      const dias = uniq(
        ROWS.filter(r => String(r[H_ESC]).trim() === esc)
            .map(r => String(r[H_DIA]).trim())
      ).sort();

      for (const d of dias) {
        const opt=document.createElement('option'); opt.value=d; opt.textContent=d; $dia.appendChild(opt);
      }
      $dia.disabled = false;
      $status.textContent = "Elegí día.";
    });

    // Cascada: Día -> Horario
    $dia.addEventListener('change', () => {
      $horario.innerHTML = '<option value="">(Elegí horario)</option>';
      $horario.disabled = true;
      $resultados.innerHTML = "";
      updateCounter(0);

      const esc = $escuela.value.trim();
      const dia = $dia.value.trim();
      if (!esc || !dia) { $status.textContent = "Elegí escuela y día."; return; }

      const horarios = uniq(
        ROWS.filter(r => String(r[H_ESC]).trim() === esc && String(r[H_DIA]).trim() === dia)
            .map(r => String(r[H_HOR]).trim())
      ).sort();

      for (const h of horarios) {
        const opt=document.createElement('option'); opt.value=h; opt.textContent=h; $horario.appendChild(opt);
      }
      $horario.disabled = false;
      $status.textContent = "Elegí horario.";
    });

    // Resultado: agrupar por COMISION y mostrar detalles extra
    $horario.addEventListener('change', () => {
      $resultados.innerHTML = "";

      const esc = $escuela.value.trim();
      const dia = $dia.value.trim();
      const hor = $horario.value.trim();
      if (!esc || !dia || !hor) { $status.textContent = "Completá los 3 filtros."; updateCounter(0); return; }

      const rows = ROWS.filter(r =>
        String(r[H_ESC]).trim() === esc &&
        String(r[H_DIA]).trim() === dia &&
        String(r[H_HOR]).trim() === hor
      );

      const grupos = {};
      rows.forEach(r => {
        const key = String(r[H_COM]).trim();
        if (!grupos[key]) grupos[key] = [];
        grupos[key].push(r);
      });

      renderResultados(grupos);
    });

    // Limpiar todo
    document.getElementById('limpiar').addEventListener('click', () => {
      $escuela.value = "";
      setDireccionAside([]);
      $dia.innerHTML = '<option value="">(Elegí día)</option>';
      $horario.innerHTML = '<option value="">(Elegí horario)</option>';
      $dia.disabled = true; $horario.disabled = true;
      $resultados.innerHTML = "";
      updateCounter(0);
      $status.textContent = "Elegí escuela.";
    });
  </script>
</body>
</html>



